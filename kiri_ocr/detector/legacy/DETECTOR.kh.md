# ឯកសារបច្ចេកទេស៖ ប្រព័ន្ធកំណត់អត្តសញ្ញាណអត្ថបទ (Text Detector)

## ទិដ្ឋភាពទូទៅ

ថ្នាក់ `TextDetector` គឺជាប្រព័ន្ធកំណត់អត្តសញ្ញាណអត្ថបទកម្រិតខ្ពស់ ដែលមិនប្រកាន់ភាសា (Language-Agnostic)។ វាត្រូវបានបង្កើតឡើងដោយយកគំរូតាម "ការវិភាគប្លង់ទំព័រ" (Page Layout Analysis) របស់ Tesseract OCR។ ប្រព័ន្ធនេះប្រើប្រាស់ **យុទ្ធសាស្ត្រចាប់យកអត្ថបទជាច្រើនរួមគ្នា** ដើម្បីស្វែងរកទីតាំងអត្ថបទនៅក្នុងរូបភាពយ៉ាងមានប្រសិទ្ធភាព ដោយមិនគិតពី៖

- **អក្សរ/ភាសា**៖ ខ្មែរ អង់គ្លេស អារ៉ាប់ ចិន ថៃ និងភាសាផ្សេងៗទៀត។
- **ពណ៌ផ្ទៃខាងក្រោយ**៖ ពណ៌ស ខ្មៅ ពណ៌ចម្រុះ ឬមានក្បាច់រចនា។
- **ពណ៌អត្ថបទ**៖ ពណ៌អ្វីក៏បាន។
- **គុណភាពរូបភាព**៖ ឯកសារស្កេន រូបថត ឬ Screenshot។

## លក្ខណៈពិសេសសំខាន់ៗ

| លក្ខណៈពិសេស | ការពិពណ៌នា |
|---------|-------------|
| **ការចាប់យកពហុវិធីសាស្ត្រ** | រួមបញ្ចូល Connected Components + MSER + Gradient Analysis |
| **ការបំប្លែងពហុពណ៌ (Multi-Channel)** | វិភាគលើពណ៌ RGB, HSV, និង LAB (ប្រើវិធីសាស្ត្រជាង ២០ ដើម្បីបំប្លែងជារូបភាពស-ខ្មៅ) |
| **ទំហំសម្របតាមស្វ័យប្រវត្តិ** | ដំណើរការបានទាំងរូបភាពតូច និងឯកសារ A4 ធំៗ |
| **ពិន្ទុទំនុកចិត្ត (Confidence)** | ការរកឃើញនីមួយៗមានភ្ជាប់មកជាមួយកម្រិតពិន្ទុនៃភាពត្រឹមត្រូវ |
| **លទ្ធផលជាលំដាប់ថ្នាក់** | ចាប់យកជា៖ ប្លុក (Block) → បន្ទាត់ (Line) → ពាក្យ (Word) → តួអក្សរ (Character) |
| **Auto Padding** | គណនាកន្លែងទំនេរជុំវិញប្រអប់អត្ថបទដោយស្វ័យប្រវត្តិ |
| **ការពង្រីកទំហំ (Multi-Scale)** | ជម្រើសក្នុងការចាប់យកទាំងអត្ថបទតូច និងធំក្នុងពេលតែមួយ |
| **Debug Mode** | បង្ហាញរូបភាពនៃការដំណើរការពីមួយជំហានទៅមួយជំហាន |

---

## តម្រូវការដំឡើង (Installation Requirements)

```python
import cv2
import numpy as np
from dataclasses import dataclass
from typing import List, Tuple, Optional, Dict, Union
from enum import Enum
from pathlib import Path
```

---

## ការចាប់ផ្តើមរហ័ស (Quick Start)

```python
from text_detector import TextDetector

# ការប្រើប្រាស់មូលដ្ឋាន
detector = TextDetector()

# ចាប់យកបន្ទាត់អត្ថបទ
lines = detector.detect_lines("image.png")
# លទ្ធផល៖ [(x, y, w, h), ...] ជាកូអរដោនេ

# ចាប់យកពាក្យ
words = detector.detect_words("image.png")

# ចាប់យកជាលំដាប់ថ្នាក់ពេញលេញ
hierarchy = detector.detect_all("image.png")
for block in hierarchy:
    print(f"Block: {block.bbox}, confidence: {block.confidence:.2f}")
    for line in block.children:
        print(f"  Line: {line.bbox}")
```

---

## ទិដ្ឋភាពទូទៅនៃស្ថាបត្យកម្ម (Architecture Overview)

```
┌─────────────────────────────────────────────────────────────────┐
│                        រូបភាពដើម (INPUT IMAGE)                   │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                 ការចាប់យកពហុវិធីសាស្ត្រ (MULTI-METHOD)           │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │ Connected   │  │   MSER      │  │  Gradient   │              │
│  │ Components  │  │ Detection   │  │  Detection  │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
│         │                │                │                      │
│         └────────────────┴────────────────┘                      │
│                          │                                       │
│                          ▼                                       │
│               បូកបញ្ចូលបេក្ខភាពទាំងអស់ (Merge)                  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    ការសម្រាញ់ & លុបការត្រួតគ្នា                  │
│  • សម្រាញ់តាមទំហំ (កម្ពស់, ទទឹង, ទំនាក់ទំនងទទឹង/កម្ពស់)        │
│  • លុបប្រអប់ដែលត្រួតគ្នាដោយប្រើ IoU (NMS-like)                  │
│  • ផ្តល់ចំណាត់ថ្នាក់តាមពិន្ទុទំនុកចិត្ត (Confidence)              │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                     ជុំនុំជាក្រុម & លំដាប់ថ្នាក់                 │
│  • ការដាក់ជាបន្ទាត់ (តាម Baseline clustering)                    │
│  • ការដាក់ជាពាក្យ (វិភាគគម្លាត Gap analysis)                     │
│  • ការដាក់ជាកថាខណ្ឌ (វិភាគគម្លាតបន្ទាត់)                         │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                         លទ្ធផល (OUTPUT)                          │
│  • បញ្ជី TextBox (មានកូអរដោនេ, ពិន្ទុ, និងកម្រិត)                │
│  • លំដាប់ថ្នាក់ជម្រើស (ប្លុក → បន្ទាត់ → ពាក្យ)                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## វិធីសាស្ត្រចាប់យកអត្ថបទ (Detection Methods Explained)

### វិធីសាស្ត្រទី ១៖ Connected Components Analysis

នេះគឺជាវិធីសាស្ត្រចម្បងដោយប្រើប្រាស់ការបំប្លែងពណ៌ជាច្រើនដំណាក់កាល។

#### ការបំប្លែងរូបភាពជាស-ខ្មៅ (Binarization Methods) - សរុបជាង ២០ វិធី

1.  **Grayscale Binarizations (រូបភាពសខ្មៅ)**:
    *   `otsu`: ល្អសម្រាប់ឯកសារច្បាស់លាស់។
    *   `adaptive_gauss`: ល្អសម្រាប់រូបភាពដែលមានពន្លឺមិនស្មើគ្នា។
    *   `sauvola`: ល្អសម្រាប់ឯកសារដែលមានស្រមោល។
2.  **Color Channel Binarizations (បំប្លែងតាមពណ៌)**:
    *   `RGB channels`: ពិនិត្យលើពណ៌ ក្រហម បៃតង ខៀវ ដាច់ដោយឡែក។
    *   `HSV`: ពិនិត្យលើពន្លឺ (Value) និង កម្រិតពណ៌ (Saturation)។
    *   `LAB`: វិធីសាស្ត្រវិភាគពណ៌បែបកម្រិតខ្ពស់។

#### ការផ្តល់ពិន្ទុលើការបំប្លែង (Scoring)

រាល់រូបភាពដែលបំប្លែងរួច នឹងត្រូវបានផ្តល់ពិន្ទុដោយផ្អែកលើលក្ខណៈអត្ថបទ៖
*   ចំនួនសមាសធាតុដែលមើលទៅដូចអក្សរ។
*   ភាពស្មើគ្នានៃកម្ពស់អក្សរ។
*   សមាមាត្រត្រឹមត្រូវនៃតួអក្សរ។

---

### វិធីសាស្ត្រទី ២៖ MSER Detection

**Maximally Stable Extremal Regions (MSER)** ស្វែងរកតំបន់ដែលមានស្ថេរភាពនៅពេលផ្លាស់ប្តូរកម្រិតពន្លឺ។ វិធីសាស្ត្រនេះមានប្រសិទ្ធភាពខ្ពស់សម្រាប់អត្ថបទ ព្រោះតួអក្សរតែងតែមានពណ៌ខុសពីផ្ទៃខាងក្រោយទោះបីជាពន្លឺប្រែប្រួលក៏ដោយ។

---

### វិធីសាស្ត្រទី ៣៖ Gradient Detection

ប្រើប្រាស់ការវិភាគគែម (Edge/Stroke analysis) ស្រដៀងនឹងបច្ចេកទេស Stroke Width Transform (SWT)។ វាស្វែងរកតំបន់ណាដែលមានកម្រាស់នៃគំនូសអក្សរ (Stroke width) ថេរ ដែលជាលក្ខណៈពិសេសនៃអក្សរ។

---

## ជំហាននៃការសម្រាញ់ (Component Filtering Pipeline)

### ១. ការសម្រាញ់តាមទំហំមូលដ្ឋាន
```python
if w >= min_text_width and h >= min_text_height:
    # រក្សាទុកតែសមាសធាតុដែលមានទំហំសមរម្យ
```

### ២. ការសម្រាញ់តាមសមាមាត្រ (Aspect Ratio)
```python
aspect_ratio = width / height
if 0.02 < aspect_ratio < 50:
    # បោះចោលខ្សែបន្ទាត់វែងៗ ឬ ចំណុចតូចពេក
```

### ៣. ការលុបការត្រួតគ្នា (Deduplication - IoU)
ប្រសិនបើវិធីសាស្ត្រពីរផ្សេងគ្នា រកឃើញប្រអប់នៅកន្លែងតែមួយ៖
*   គណនា IoU (Intersection over Union) ។
*   ប្រសិនបើ IoU > 0.5 (ត្រួតគ្នាខ្លាំង) នោះប្រព័ន្ធនឹងជ្រើសរើសយកប្រអប់ណាដែលមាន **ពិន្ទុទំនុកចិត្ត (Confidence)** ខ្ពស់ជាង។

---

## ក្បួនដោះស្រាយការដាក់ជាក្រុម (Grouping Algorithm)

### ការដាក់ជាបន្ទាត់ (Line Grouping)

ប្រព័ន្ធប្រើ **Baseline Clustering**៖
1.  តម្រៀបសមាសធាតុតាមអ័ក្ស Y (កម្ពស់)។
2.  កំណត់កម្រិតអនុគ្រោះ (Threshold) = `0.6 × កម្ពស់មធ្យមនៃអក្សរ`។
3.  ប្រសិនបើតួអក្សរស្ថិតក្នុងកម្រិតកម្ពស់នេះ វាត្រូវបានរាប់បញ្ចូលក្នុងបន្ទាត់ជាមួយគ្នា។

វិធីនេះអាចដោះស្រាយបញ្ហាអក្សរដែលមានជើងវែង (ដូចជា ខ្មែរដាក់ជើង, អក្សរ g, y) បានយ៉ាងល្អ។

### ការបំបែកពាក្យ (Word Segmentation)

```python
# គណនាគម្លាតរវាងតួអក្សរក្នុងបន្ទាត់
gap = next_char_x - (prev_char_x + prev_char_width)

# ប្រសិនបើគម្លាតធំជាងកម្រិតកំណត់ -> បំបែកពាក្យ
if gap > word_gap_threshold:
    new_word()
```
កម្រិតកំណត់ (Threshold) ត្រូវបានគណនាដោយស្វ័យប្រវត្តិ ដោយផ្អែកលើស្ថិតិនៃគម្លាតនៅក្នុងបន្ទាត់នោះ។

---

## ប៉ារ៉ាម៉ែត្រកំណត់ (Initialization Parameters)

```python
detector = TextDetector(
    padding=None,              # កន្លែងទំនេរជុំវិញ (None=ស្វ័យប្រវត្តិ)
    min_text_height=6,         # កម្ពស់អក្សរអប្បបរមា
    min_confidence=0.3,        # កម្រិតទំនុកចិត្តអប្បបរមាដើម្បីបង្ហាញលទ្ធផល
    use_mser=True,             # ប្រើ MSER (បើក/បិទ)
    use_gradient=True,         # ប្រើ Gradient (បើក/បិទ)
    use_color_channels=True,   # ប្រើការវិភាគពណ៌ (បើក/បិទ)
    scales=(1.0,),             # កម្រិតពង្រីករូបភាព (Zoom)
    debug=False                # បង្ហាញរូបភាព Debug
)
```

---

## ឧទាហរណ៍នៃការប្រើប្រាស់

### ការស្វែងរកអត្ថបទលើផ្ទៃខាងក្រោយមានពណ៌

```python
# សម្រាប់រូបភាពដែលមានផ្ទៃខាងក្រោយពណ៌ចម្រុះ
detector = TextDetector(
    use_color_channels=True,  # ដំណើរការពណ៌ RGB, HSV, LAB
    use_mser=True,            # MSER ល្អសម្រាប់ពណ៌
)

lines = detector.detect_lines("colored_poster.png")
```

### ការស្វែងរកលើរូបភាពគុណភាពទាប ឬអក្សរតូចៗ

```python
# សម្រាប់រូបភាពមិនច្បាស់ ឬអក្សរតូច
detector = TextDetector(
    min_text_height=4,        # អនុញ្ញាតអក្សរតូចជាងមុន
    min_confidence=0.2,       # ទទួលយកកម្រិតទំនុកចិត្តទាបជាងមុន
    scales=(1.0, 2.0),        # ពង្រីករូបភាពដើម្បីចាប់យកអក្សរតូច
)

lines = detector.detect_lines("low_quality_scan.png")
```

### ការបង្កើនល្បឿន (Speed Optimization)

```python
# សម្រាប់ការដំណើរការលឿនបំផុត (បិទមុខងារបន្ថែម)
detector = TextDetector(
    use_mser=False,           
    use_gradient=False,       
    use_color_channels=False, # ប្រើតែរូបភាពសខ្មៅ
    scales=(1.0,),            
)
```

---

## ការប្រៀបធៀប៖ កំណែចាស់ vs កំណែថ្មី

| លក្ខណៈពិសេស | កំណែចាស់ (Original) | កំណែថ្មី (New) |
|---------|----------|-----|
| ការគាំទ្រពណ៌ | Grayscale តែប៉ុណ្ណោះ | RGB + HSV + LAB Channel |
| វិធីសាស្ត្រ Binarization | ៦ វិធី | ជាង ២០ វិធី |
| យុទ្ធសាស្ត្រចាប់យក | Connected Components | CC + MSER + Gradient |
| ការលុបការត្រួតគ្នា | Overlap Merge | IoU-based NMS (ល្អជាង) |
| ពិន្ទុទំនុកចិត្ត (Score) | គ្មាន | មាន |
| លំដាប់ថ្នាក់ | បន្ទាត់/ពាក្យ ប៉ុណ្ណោះ | ប្លុក → បន្ទាត់ → ពាក្យ → អក្សរ |
| Multi-scale | គ្មាន | មាន (អាច Zoom រូបភាពបាន) |
| ទម្រង់លទ្ធផល | Tuples | TextBox Object (ងាយស្រួលប្រើជាង) |

---

## ដំណោះស្រាយបញ្ហា (Troubleshooting)

**១. បញ្ហា៖ បាត់អត្ថបទនៅលើផ្ទៃខាងក្រោយពណ៌**
*   **ដំណោះស្រាយ៖** ត្រូវប្រាកដថាបានបើក `use_color_channels=True`។

**២. បញ្ហា៖ ចាប់បានប្រអប់មិនពាក់ព័ន្ធច្រើនពេក (Noise)**
*   **ដំណោះស្រាយ៖** បង្កើន `min_confidence` ទៅ 0.5 (លំនាំដើមគឺ 0.3)។

**៣. បញ្ហា៖ មិនឃើញអក្សរតូចៗ**
*   **ដំណោះស្រាយ៖** ប្រើ `scales=(1.0, 2.0)` ដើម្បីពង្រីករូបភាពពេលវិភាគ។

**៤. បញ្ហា៖ ដំណើរការយឺត**
*   **ដំណោះស្រាយ៖** បិទ `use_mser`, `use_gradient`, និង `use_color_channels` ប្រសិនបើមិនចាំបាច់។

---

## អាជ្ញាប័ណ្ណ (License)

ជាផ្នែកមួយនៃប្រព័ន្ធ Kiri OCR System។